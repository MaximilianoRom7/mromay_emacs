
(defun local:odoo-kill()
  (interactive)
  (local:concat-shell-run
   "lsof -i"
   "grep python"
   "grep LISTEN"
   "grep ':80'"
   "tr -s ' '"
   "cut -d ' ' -f2"
   "xargs -L1 kill -9")
  (local:python-kill-pdb))

(defun local:buffer-kill-noconfirm(buff)
  "kill-buffer-without-confirmation"
  (interactive)
  (with-current-buffer buff
    (let ((buffer-modified-p nil))
      (kill-this-buffer))))

(defun local:python-kill-pdb(&optional confirm)
  "kill all the pdb buffers"
  (interactive)
  (let ((buffers (filter-string "pdb" (mapcar #'buffer-name (buffer-list)))))
    (if confirm
	;; ask confirmation
	(mapc #'kill-buffer buffers)
      ;; do not ask
      (mapc #'local:buffer-kill-noconfirm buffers))))

(defun local:odoo-start(&optional start_script)
  (interactive)
  (let ((buff (filter-string "pdb" (mapcar #'buffer-name (buffer-list)))))
    (if buff
	;; pdb is running
	(progn
	  (switch-to-buffer (get-buffer-create (car buff)))
	  ))
    (if start_script
	(progn
	  (unless (stringp start_script)
	    (setq start_script (completing-read "Choose an odoo: " local:odoo-paths)))
	  (realgud:pdb
	   (concat "python2 -m pdb " start_script) t))
      ;; else
      (realgud:pdb
       (concat "python2 -m pdb odoo.py --config=odoo-server.conf") t))
    ))

;; odoo paths
;; /home/skyline/Development/versions/repos/odoo10/lib/python2.7/site-packages/odoo/odoo

(defun local:odoo-kill-start(&optional start_script)
  (interactive)
  (local:odoo-kill)
  ;; don't know why but without delay does not work
  (sit-for 0.3)
  (local:odoo-start start_script))

(setq local:odoo-paths
      '("/home/skyline/Development/versions/repos/odoo10/lib/python2.7/site-packages/odoo/odoo/start_odoo.py"))

(global-set-key (kbd "C-c o") (local:wrapp 'local:odoo-kill-start '(t)))
